@using ProiectWeb.Models
@inject UserManager<ApplicationUser> UserManager
@inject SignInManager<ApplicationUser> SignInManager

<ul class="navbar-nav">
    @{
        ApplicationUser? user = null;
        if (SignInManager.IsSignedIn(User))
        {
            user = await UserManager.GetUserAsync(User);
        }
    }

    @if (user != null)
    {
        <li class="nav-item">
            <a class="nav-link text-white" asp-area="Identity" asp-page="/Account/Manage/Index" title="Edit Profile">
                Hello @user.Nickname
            </a>
        </li>
        <li class="nav-item">
            <form id="logoutForm" class="form-inline"
                  asp-area="Identity" asp-page="/Account/Logout"
                  asp-route-returnUrl="@Url.Page("/Index", new { area = "" })"
                  method="post">
                <button type="submit" class="btn btn-login">Logout</button>
            </form>
        </li>
    }
    else
    {
        <li class="nav-item">
            <a class="btn btn-register" asp-area="Identity" asp-page="/Account/Register">Register</a>
        </li>
        <li class="nav-item">
            <a class="btn btn-login" asp-area="Identity" asp-page="/Account/Login">Login</a>
        </li>

        
        <script>
            
            sessionStorage.clear();
            
            localStorage.removeItem("chat_history"); // legacy key
        </script>
    }
</ul>

<script>
document.addEventListener("DOMContentLoaded", () => {
    const logoutForm = document.getElementById("logoutForm");
    if (logoutForm) {
        logoutForm.addEventListener("submit", () => {
            sessionStorage.clear();
            
            localStorage.removeItem("chat_history");
        });
    }

    if (!logoutForm) {
        const anyLogoutForm = document.querySelector('form[action*="/Account/Logout"]');
        if (anyLogoutForm) {
            anyLogoutForm.addEventListener("submit", () => {
                sessionStorage.clear();
                localStorage.removeItem("chat_history");
            });
        }
    }
});
</script>
